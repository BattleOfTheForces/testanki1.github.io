<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>
	3D坦克服务器状态页面
</title>
<h1>
	<strong><span style="font-size:18px;">国服</span></strong> 
</h1>
<p>
	在线：<span id="onlineCount"></span> 
</p>
<p>
	战斗中：<span id="inbattlesCount"></span> 
</p>
<p>
	4399：<span id="my4399ComCount"></span> 
</p>
<p>
	<br />
</p>
<p id="updateStatus">
	预更新：
</p>
<h1>
	<strong><span style="font-size:18px;">外服</span></strong> 
</h1>
<p id="euUpdateStatus">
	预更新：
</p>
<p id="updateTime">
	预计更新时间：
</p>
<script>
    function fetchBalancerStats() {
      fetch('https://balancer.3dtank.com/balancer')
        .then(response => response.json())
        .then(data => {
          let totalInbattles = 0;
          let totalOnline = 0;
          let totalMy4399Com = 0;
          Object.values(data.nodes).forEach(node => {
            totalInbattles += node.inbattles || 0;
            totalOnline += node.online || 0;
            totalMy4399Com += node.partners && node.partners.my_4399_com ? node.partners.my_4399_com : 0;
          });
          const my4399ComCount = totalMy4399Com || 0;
          document.getElementById('inbattlesCount').innerText = totalInbattles;
          document.getElementById('onlineCount').innerText = totalOnline;
          document.getElementById('my4399ComCount').innerText = my4399ComCount;
        })
        .catch(error => console.error('获取数据时出错：', error));
    }
    function checkUpdateStatus() {
      fetch('https://c3.3dtank.com/stage-balancer')
        .then(response => response.status === 502 ? '否' : response.json())
        .then(data => {
          const hasC3Node = data && data.nodes && data.nodes['cn-stage-game.c3'];
          const updateStatus = hasC3Node ? '是' : '否';
          document.getElementById('updateStatus').innerText = `预更新：${updateStatus}`;
        })
        .catch(error => {
          console.error('获取预更新状态时出错：', error);
          document.getElementById('updateStatus').innerText = '预更新：否';
        });
    }
    function checkEUUpdateStatus() {
      fetch('https://balancer.eu.tankionline.com/datacenter')
        .then(response => response.status === 502 ? '否' : response.json())
        .then(data => {
          const hasDeploy = data && data.datacenters && Object.keys(data.datacenters).some(key => key !== 'default');
          const updateStatus = hasDeploy ? '是' : '否';
          document.getElementById('euUpdateStatus').innerText = `预更新：${updateStatus}`;
          if (updateStatus !== '否') {
            const nonDefaultDatacenter = Object.keys(data.datacenters).find(key => key !== 'default');
            if (nonDefaultDatacenter) {
              const expireDate = data.datacenters[nonDefaultDatacenter].expireDate;
              const gmtTime = new Date(expireDate);
              const gmtPlus8Time = gmtTime.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
              document.getElementById('updateTime').innerText = `预计更新时间：${gmtPlus8Time}`;
            } else {
              document.getElementById('updateTime').innerText = '预计更新时间：暂无';
            }
          } else {
            document.getElementById('updateTime').innerText = '预计更新时间：暂无';
          }
        })
        .catch(error => {
          console.error('获取外服预更新状态时出错：', error);
          document.getElementById('euUpdateStatus').innerText = '预更新：否';
          document.getElementById('updateTime').innerText = '预计更新时间：暂无';
        });
    }
    // 初始获取
    fetchBalancerStats();
    checkUpdateStatus();
    checkEUUpdateStatus();
    // 每隔10秒刷新一次
    setInterval(() => {
      fetchBalancerStats();
      checkUpdateStatus();
      checkEUUpdateStatus();
    }, 10000);
</script>
