<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p&display=swap" rel="stylesheet">
    <title>3D坦克排行榜</title>
    <style>
        :root {
            --primary-bg: #001926;
            --secondary-bg: #0a192f;
            --border-color: #5C6C74;
            --accent-color: #76FF33;
            --accent-color-hover: #66cc29;
            --text-color: #e0e0e0;
            --text-light: #BFD5FF;
            --error-color: #FF6666;
            --header-bg: rgba(125, 157, 186, 0.12);
            --increase-color: #76FF33;
            --decrease-color: #FF6666;
        }

        * {
            font-family: 'Rubik', 'M PLUS 1p', sans-serif;
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: var(--primary-bg);
            color: var(--text-color);
        }

        h1 {
            text-align: center;
            margin: 0 0 20px;
            color: var(--accent-color);
        }

        /* --- Form --- */
        .form-container {
            max-width: 400px;
            margin: 0 auto 20px;
            padding: 20px;
            background-color: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:disabled,
        .form-group select:disabled {
            background-color: #2a3b4c;
            cursor: not-allowed;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        .form-group button {
            width: 100%;
            padding: 12px 24px;
            background-color: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s, box-shadow 0.3s;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .form-group button:hover:not(:disabled) {
            background-color: var(--accent-color-hover);
        }
        .form-group button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            margin-top: 15px;
            min-height: 1.2em;
        }
        
        /* --- Results Area --- */
        .results-wrapper { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Monitor Button --- */
        .monitor-container {
            text-align: center;
            margin-bottom: 20px;
        }
        #monitorButton {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s, box-shadow 0.3s;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            background-color: #00D4FF;
            color: white;
        }
        #monitorButton:hover:not(:disabled) {
            background-color: #2e5a8e;
        }
        #monitorButton:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        #monitorButton.monitoring {
            background-color: var(--error-color);
            color: white;
            animation: pulse 1.5s infinite;
        }
        #monitorButton.monitoring:hover {
            background-color: #cc5252;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 102, 102, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 102, 102, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 102, 102, 0); }
        }

        /* --- Tabs --- */
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background: none; color: var(--text-light); font-size: 16px; font-weight: 500; position: relative; transition: color 0.3s; }
        .tab-button:after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background-color: var(--accent-color); transform: scaleX(0); transition: transform 0.3s; }
        .tab-button.active { color: var(--accent-color); }
        .tab-button.active:after { transform: scaleX(1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Initial Message & Loader --- */
        #initialMessage { text-align: center; color: #aaa; padding: 40px 20px; font-style: italic; border: 2px dashed var(--border-color); border-radius: 12px; }
        .loader { display: none; justify-content: center; align-items: center; margin: 30px 0; }
        .loader-inner { width: 30px; height: 30px; border-radius: 50%; border: 4px solid var(--border-color); border-top-color: var(--text-color); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Profile Summary --- */
        #profileSummary { background-color: var(--secondary-bg); border-radius: 12px; padding: 20px; margin-bottom: 30px; border: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .summary-item { display: flex; flex-direction: column; }
        .summary-label { font-size: 14px; color: var(--text-light); margin-bottom: 4px; }
        .summary-value { font-size: 16px; font-weight: 500; }
        .summary-value.premium { color: var(--accent-color); }

        /* --- Rankings Table --- */
        #rankingsTableContainer { margin-bottom: 30px; overflow-x: auto; }
        table { width: 100%; min-width: 500px; border-collapse: collapse; color: var(--text-color); }
        th, td { padding: 12px 15px; text-align: center; font-size: 14px; white-space: nowrap; }
        th { background: var(--header-bg); font-weight: 600; border-bottom: 2px solid var(--accent-color); position: sticky; top: 0; z-index: 2; }
        tr:nth-child(even) { background: var(--header-bg); }
        tr:nth-child(odd) { background: rgba(125, 157, 186, 0.05); }

        /* --- Data Change Highlighting --- */
        .change-indicator { font-size: 0.8em; font-weight: bold; margin-left: 8px; padding: 2px 5px; border-radius: 4px; }
        .change-increase { color: var(--increase-color); }
        .change-decrease { color: var(--decrease-color); }
        .field-changed { color: var(--increase-color); transition: color 0.3s ease-in-out; }

        /* --- Dynamic Lists (Cards) --- */
        .list-section { margin-bottom: 30px; }
        .list-title { text-align: center; margin-bottom: 15px; font-size: 1.5em; color: var(--text-light); font-weight: 500; }
        .list-container { display: flex; overflow-x: auto; padding: 10px 0; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .list-container > * { scroll-snap-align: center; }
        .data-card { flex: 0 0 280px; background-color: var(--secondary-bg); padding: 15px; margin: 0 10px; border-radius: 10px; max-height: 420px; overflow-y: auto; display: flex; flex-direction: column; text-align: center; border: 1px solid var(--border-color); transition: border-color 0.3s, transform 0.3s; }
        .data-card.changed { border-color: var(--accent-color); transform: translateY(-5px); }
        .item-name { position: sticky; top: 0; background-color: var(--secondary-bg); z-index: 1; padding: 5px 0 10px 0; font-size: 18px; font-weight: 500; }
        .item-image { display: block; width: 80px; height: 80px; margin: 0 auto 10px auto; object-fit: contain; }
        .data-card div { font-size: 14px; margin: 5px 0; }
        .view-data-button, .close-button { display: inline-block; padding: 8px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; text-align: center; cursor: pointer; transition: background-color 0.3s; margin: 15px auto 5px auto; text-decoration: none; }
        .view-data-button { background-color: var(--accent-color); color: var(--primary-bg); }
        .view-data-button:hover { background-color: var(--accent-color-hover); }
        .close-button { background-color: var(--error-color); color: #fff; }
        .no-data-message { text-align: center; color: #aaa; padding: 20px; background-color: rgba(10, 25, 47, 0.5); border-radius: 8px; font-style: italic; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 999; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--primary-bg); padding: 20px; border-radius: 10px; width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border-color); text-align: center; }
        .modal-content h3 { margin-top: 0; color: var(--accent-color); }
        .modal-content table { margin: 15px 0; min-width: auto; }
        .modal-content th { background: rgba(125, 157, 186, 0.2); }
        
        /* --- Change Log --- */
        #changeLogContainer { max-height: 80vh; overflow-y: auto; padding: 10px; background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 12px; }
        .log-entry { background-color: var(--primary-bg); padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--accent-color); }
        .log-entry:last-child { margin-bottom: 0; }
        .log-timestamp { font-size: 12px; color: #aaa; margin-bottom: 8px; }
        .log-details { font-size: 14px; }
        .log-details strong { color: var(--text-light); }
    </style>
</head>
<body>

<h1>3D坦克排行榜</h1>

<div class="form-container">
    <div class="form-group">
        <label for="region">选择服务器：</label>
        <select id="region">
            <option value="国服" disabled>国服 (维护中)</option>
            <option value="eu" selected>外服</option>
        </select>
    </div>

    <div class="form-group">
        <label for="username">输入昵称：</label>
        <input type="text" id="username" placeholder="请输入坦克昵称" />
    </div>
    
    <div class="form-group">
        <button id="fetchButton">查询资料</button>
    </div>

    <div id="errorMessage" class="error-message"></div>
</div>

<div class="loader" id="loader">
    <div class="loader-inner"></div>
</div>

<div id="initialMessage">输入昵称以开始查询</div>

<div id="resultsWrapper" class="results-wrapper">
    
    <div class="monitor-container">
        <button id="monitorButton">开启监测</button>
    </div>

    <div class="tabs">
        <button class="tab-button active" data-tab="profile">玩家资料</button>
        <button class="tab-button" data-tab="log">变更日志</button>
    </div>

    <div id="profileContent" class="tab-content active">
        <div id="profileSummary"></div>
        <div id="rankingsTableContainer"></div>
        <div id="listsContainer"></div>
    </div>

    <div id="logContent" class="tab-content">
        <div id="changeLogContainer">
            <p class="no-data-message">暂无数据变更记录</p>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_CONFIG = {
        proxyUrl: 'https://api.allorigins.win/get?url=',
        baseUrls: {
            'eu': 'https://ratings.tankionline.com/api/eu/profile/',
            'cn': 'https://ratings.3dtank.com/get_stat/profile/'
        },
        monitorInterval: 3000 // 3 seconds
    };

    const RANKS = ["新兵", "二等兵", "一等兵", "下士", "中士", "上士", "三级军士长", "二级军士长", "一级军士长", "军士长", "五级准尉", "四级准尉", "三级准尉", "二级准尉", "一级准尉", "特级准尉", "少尉", "中尉", "上尉", "少校", "中校", "上校", "准将", "少将", "中将", "上将", "元帅", "陆军元帅", "统帅", "大元帅", "传奇"];
    const LIST_DATA_CONFIGS = [{ key: 'turretsPlayed', title: '使用的炮塔' }, { key: 'hullsPlayed', title: '使用的底盘' }, { key: 'dronesPlayed', title: '使用的无人机' }, { key: 'resistanceModules', title: '使用的防御模块' }, { key: 'paintsPlayed', title: '使用的迷彩' }, { key: 'modesPlayed', title: '玩过的模式' }, { key: 'suppliesUsage', title: '使用的道具' }, { key: 'presents', title: '收到的礼物' }];
    
    // --- TRANSLATION MAP ---
    const TRANSLATION_MAP = {
        'JGR': '个人剑圣',
        'TJR': '团队剑圣',
        'RESISTANCE': '抗性',
        'SHAFT': '镭射炮',
        'THUNDER': '雷暴炮',
        'CRITICAL': '暴击',
        'MINE': '地雷',
        'RAILGUN': '激光炮',
        'FREEZE': '冰风暴',
        'SMOKY': '轰天炮',
        'RICOCHET': '火龙珠',
        'ARTILLERY': '马格南',
        'FIREBIRD': '火焰炮',
        'TWINS': '离子炮',
        'GAUSS': '电磁炮',
        'ROCKET_LAUNCHER': '火箭炮',
        'ISIS': '磁力炮',
        'TESLA': '特斯拉',
        'SCORPIO': '蝎子',
        'MACHINE_GUN': '极速炮',
        'SHOTGUN': '滑膛炮'
    };

    // --- DOM Elements ---
    const elements = {
        fetchButton: document.getElementById('fetchButton'),
        monitorButton: document.getElementById('monitorButton'),
        regionSelect: document.getElementById('region'),
        usernameInput: document.getElementById('username'),
        loader: document.getElementById('loader'),
        errorMessage: document.getElementById('errorMessage'),
        initialMessage: document.getElementById('initialMessage'),
        resultsWrapper: document.getElementById('resultsWrapper'),
        profileSummary: document.getElementById('profileSummary'),
        rankingsTableContainer: document.getElementById('rankingsTableContainer'),
        listsContainer: document.getElementById('listsContainer'),
        tabs: document.querySelectorAll('.tab-button'),
        tabContents: document.querySelectorAll('.tab-content'),
        changeLogContainer: document.getElementById('changeLogContainer')
    };

    // --- STATE ---
    let isMonitoring = false;
    let monitoringTimeoutId = null;
    let lastProfileData = null;
    let changeLog = [];
    let currentUsername = '';
    let currentRegion = '';

    // --- Event Listeners ---
    elements.fetchButton.addEventListener('click', handleFetch);
    elements.monitorButton.addEventListener('click', toggleMonitoring);
    elements.usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleFetch(); });
    elements.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            elements.tabs.forEach(t => t.classList.remove('active'));
            elements.tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.querySelector(`#${tab.dataset.tab}Content`).classList.add('active');
        });
    });
    
    // --- Translation Function ---
    function translateText(text) {
        if (typeof text !== 'string' || !text) return text;

        let translated = text;
        // Using an array to define replacement order if necessary (longer keys first)
        const replacementOrder = [
            'ROCKET_LAUNCHER', 'MACHINE_GUN', 'FIREBIRD', 'RESISTANCE', 'RICOCHET', 
            'ARTILLERY', 'SHOTGUN', 'THUNDER', 'CRITICAL', 'RAILGUN', 'FREEZE', 
            'SCORPIO', 'SMOKY', 'SHAFT', 'TWINS', 'GAUSS', 'TESLA', 'ISIS', 'MINE',
            'JGR', 'TJR'
        ];

        replacementOrder.forEach(key => {
            if (TRANSLATION_MAP[key]) {
                translated = translated.replace(new RegExp(key, 'g'), TRANSLATION_MAP[key]);
            }
        });

        // As per request, remove the last underscore. Interpreted as removing all for cleaner suffixes.
        // Example: SHAFT_LEGACY -> 镭射炮_LEGACY -> 镭射炮LEGACY
        if (translated.includes('_')) {
             translated = translated.replace(/_/g, '');
        }

        return translated;
    }


    // --- Main Functions ---
    async function handleFetch() {
        if (isMonitoring) {
            displayError('请先停止监测再进行新的查询');
            return;
        }

        currentRegion = elements.regionSelect.value;
        currentUsername = elements.usernameInput.value.trim();

        if (!currentUsername) {
            displayError('请输入昵称');
            return;
        }

        clearDisplay(true);
        setLoading(true);

        try {
            const profileData = await fetchProfileData(currentRegion, currentUsername);
            updateDisplay(profileData);
            lastProfileData = profileData;
        } catch (error) {
            console.error('获取数据时出错:', error);
            displayError(error.message);
            elements.initialMessage.style.display = 'block';
        } finally {
            setLoading(false);
        }
    }

    async function fetchProfileData(region, username) {
        const baseUrl = API_CONFIG.baseUrls[region];
        if (!baseUrl) throw new Error('无效的服务器选择');
        
        try {
            const targetUrl = `${baseUrl}?user=${encodeURIComponent(username)}&lang=cn&_=${Date.now()}`;
            const apiUrl = `${API_CONFIG.proxyUrl}${encodeURIComponent(targetUrl)}`;
            
            const response = await fetch(apiUrl);

            if (!response.ok) throw new Error(`网络响应错误: ${response.status}`);

            const data = await response.json();
            if (!data.contents) {
                if (data && data.error) throw new Error(`代理错误: ${data.error}`);
                throw new Error('API 返回空响应，可能是昵称错误或服务器问题。');
            }

            const profileData = JSON.parse(data.contents);
            if (profileData?.responseType === 'NOT_FOUND') {
                throw new Error('找不到该玩家。请检查昵称或该玩家是否在游戏中隐藏了个人资料。');
            } else if (profileData?.response) {
                return profileData.response;
            } else {
                throw new Error('无效的响应数据格式');
            }
        } catch (err) {
            throw err; // 重新抛出错误
        }
    }

    // --- Monitoring ---
    function toggleMonitoring() {
        if (isMonitoring) {
            stopMonitoring();
        } else {
            if (!lastProfileData) {
                displayError('请先至少查询一次，再开启监测');
                return;
            }
            isMonitoring = true;
            startMonitoring();
        }
    }

    function startMonitoring() {
        if (!isMonitoring) return;
        
        elements.monitorButton.textContent = "停止监测";
        elements.monitorButton.classList.add('monitoring');
        elements.fetchButton.disabled = true;
        elements.usernameInput.disabled = true;
        elements.regionSelect.disabled = true;

        displayError("监测已开启...");
        performMonitoringFetch(); // 立即执行第一次
    }

    function stopMonitoring() {
        isMonitoring = false;
        clearTimeout(monitoringTimeoutId);

        elements.monitorButton.textContent = "开启监测";
        elements.monitorButton.classList.remove('monitoring');
        elements.fetchButton.disabled = false;
        elements.usernameInput.disabled = false;
        elements.regionSelect.disabled = false;

        displayError('');
    }

    async function performMonitoringFetch() {
        if (!isMonitoring) return;

        try {
            const newData = await fetchProfileData(currentRegion, currentUsername);
            if (isMonitoring) displayError('监测中...数据已刷新');
            updateDisplay(newData, lastProfileData);
            lastProfileData = newData;
        } catch (error) {
            console.error("Monitoring fetch failed, will retry:", error);
            if (isMonitoring) displayError(`监测中断: ${error.message} (${API_CONFIG.monitorInterval / 1000}秒后重试)`);
        } finally {
            if (isMonitoring) {
                monitoringTimeoutId = setTimeout(performMonitoringFetch, API_CONFIG.monitorInterval);
            }
        }
    }

    // --- Display & Update ---
    function updateDisplay(newData, oldData = null) {
        if (oldData === null) { // First load
            elements.initialMessage.style.display = 'none';
            elements.resultsWrapper.style.display = 'block';
            elements.resultsWrapper.classList.add('fade-in');
            setTimeout(() => elements.resultsWrapper.classList.remove('fade-in'), 500);
        }

        displayProfileSummary(newData, oldData);
        displayRankingsTable(newData, oldData);
        displayAllLists(newData, oldData);
    }
    
    function createChangeSpan(diff) {
        if (diff === 0 || isNaN(diff)) return '';
        const sign = diff > 0 ? '+' : '';
        const className = diff > 0 ? 'change-increase' : 'change-decrease';
        return `<span class="change-indicator ${className}">${sign}${diff.toLocaleString()}</span>`;
    }
    
    function logChange(item, oldValue, newValue) {
        const timestamp = new Date();
        const entry = {
            timestamp: timestamp.toLocaleString('zh-CN'),
            item: translateText(item),
            oldValue: oldValue?.toLocaleString() || 'N/A',
            newValue: newValue?.toLocaleString() || 'N/A'
        };
        changeLog.unshift(entry);
        renderChangeLog();
    }

    function renderChangeLog() {
        if (changeLog.length === 0) {
            elements.changeLogContainer.innerHTML = `<p class="no-data-message">暂无数据变更记录</p>`;
            return;
        }
        elements.changeLogContainer.innerHTML = changeLog.map(log => `
            <div class="log-entry">
                <div class="log-timestamp">${log.timestamp}</div>
                <div class="log-details">
                    <strong>${log.item}:</strong> 
                    从 ${log.oldValue} 变为 ${log.newValue}
                </div>
            </div>
        `).join('');
    }

    function displayProfileSummary(profile, oldProfile = null) {
        const getStat = (p, key, oldP, label) => {
            const value = p?.[key] ?? 0;
            if (!oldP) return { value: value.toLocaleString(), changeHTML: '' };
            const oldValue = oldP?.[key] ?? 0;
            if (value !== oldValue) {
                logChange(label || key, oldValue, value);
                return { value: value.toLocaleString(), changeHTML: createChangeSpan(value - oldValue) };
            }
            return { value: value.toLocaleString(), changeHTML: '' };
        };

        const kills = getStat(profile, 'kills', oldProfile, '击杀');
        const deaths = getStat(profile, 'deaths', oldProfile, '死亡');
        const score = getStat(profile, 'score', oldProfile, '经验值');
        const gearScore = getStat(profile, 'gearScore', oldProfile, '战斗力');
        const earnedCrystals = getStat(profile, 'earnedCrystals', oldProfile, '获得水晶');
        const caughtGolds = getStat(profile, 'caughtGolds', oldProfile, '获得金箱子');
        
        const totalTimePlayedMs = (profile.hullsPlayed || []).reduce((total, hull) => total + (hull.timePlayed || 0), 0);
        const totalSuppliesUsed = (profile.suppliesUsage || []).reduce((total, supply) => total + (supply.usages || 0), 0);
        const rankNum = profile.rank || 1;
        const rankName = (rankNum > 0) ? (rankNum <= RANKS.length ? RANKS[rankNum - 1] : `传奇 ${rankNum - RANKS.length}`) : "未知等级";

        const summaryData = [
            { label: '昵称', value: profile.name || 'N/A' },
            { label: '等级', value: rankName },
            { label: '经验值', value: `${score.value}${score.changeHTML} / ${profile.scoreNext?.toLocaleString() || 0}` },
            { label: 'VIP 状态', value: profile.hasPremium ? '已激活' : '未激活', isPremium: profile.hasPremium },
            { label: '战斗力', value: `${gearScore.value}${gearScore.changeHTML}` },
            { label: '击杀/死亡', value: `${kills.value}${kills.changeHTML} / ${deaths.value}${deaths.changeHTML}` },
            { label: 'K/D', value: (profile.deaths === 0) ? '∞' : (profile.kills / profile.deaths).toFixed(2) },
            { label: '游戏时长', value: formatTime(totalTimePlayedMs) },
            { label: '已用道具', value: totalSuppliesUsed.toLocaleString() },
            { label: '获得水晶', value: `${earnedCrystals.value}${earnedCrystals.changeHTML}` },
            { label: '获得金箱子', value: `${caughtGolds.value}${caughtGolds.changeHTML}` },
        ];
        
        elements.profileSummary.innerHTML = summaryData.map(item => `
            <div class="summary-item">
                <span class="summary-label">${item.label}</span>
                <span class="summary-value ${item.isPremium ? 'premium' : ''}">${item.value}</span>
            </div>
        `).join('');
    }

    function displayRankingsTable(newData, oldData = null) {
        const categories = [{ key: 'score', name: '经验值' }, { key: 'golds', name: '金箱子' }, { key: 'crystals', name: '水晶' }, { key: 'efficiency', name: '效率' }];
        const currentRating = newData.rating || {};
        const previousRating = newData.previousRating || {};
        const oldRating = oldData ? (oldData.rating || {}) : null;

        const getDisplayValue = (value) => (value === -1 || value == null) ? '-' : value.toLocaleString();
        
        const tableRows = categories.map(category => {
            const current = currentRating[category.key] || {};
            const previous = previousRating[category.key] || {};
            
            let posChangeHTML = '', valChangeHTML = '';
            if (oldRating && oldRating[category.key]) {
                const oldCat = oldRating[category.key];
                if (current.position > 0 && oldCat.position > 0 && current.position !== oldCat.position) {
                    posChangeHTML = createChangeSpan(oldCat.position - current.position); // Lower rank is better, so diff is inverted
                    logChange(`${category.name} 排名`, oldCat.position, current.position);
                }
                if (current.value !== oldCat.value) {
                    valChangeHTML = createChangeSpan(current.value - oldCat.value);
                    logChange(`${category.name} 数值`, oldCat.value, current.value);
                }
            }
            return `
                <tr>
                    <td>${category.name}</td>
                    <td>${getDisplayValue(current.position)}${posChangeHTML}</td>
                    <td>${getDisplayValue(current.value)}${valChangeHTML}</td>
                    <td>${getDisplayValue(previous.position)}</td>
                    <td>${getDisplayValue(previous.value)}</td>
                </tr>`;
        }).join('');

        elements.rankingsTableContainer.innerHTML = `<h3 class="list-title">每周排名</h3><table cellpadding="1" cellspacing="0"><thead><tr><th>类别</th><th>当前排名</th><th>当前数值</th><th>上周排名</th><th>上周数值</th></tr></thead><tbody>${tableRows}</tbody></table>`;
    }
    
    function displayAllLists(newData, oldData = null) {
        elements.listsContainer.innerHTML = '';
        LIST_DATA_CONFIGS.forEach(config => {
            const newItems = newData[config.key] || [];
            const oldItems = oldData ? (oldData[config.key] || []) : [];
            
            const section = document.createElement('div');
            section.className = 'list-section';
            const title = document.createElement('h3');
            title.className = 'list-title';
            title.textContent = config.title;
            section.appendChild(title);

            if (newItems.length === 0) {
                section.appendChild(document.createElement('p')).className = 'no-data-message';
                section.lastChild.textContent = '无数据';
            } else {
                const container = document.createElement('div');
                container.className = 'list-container';
                displayListData(newItems, oldItems, container, config.title);
                section.appendChild(container);
            }
            elements.listsContainer.appendChild(section);
        });
    }
    
    function displayListData(newItems, oldItems, container, title) {
        const aggregatedNewData = aggregateItems(newItems, title);
        const aggregatedOldData = aggregateItems(oldItems, title);
        const oldAggregatedMap = new Map(aggregatedOldData.map(item => [item.name, item]));

        aggregatedNewData.forEach(item => {
            item.changes = {};
            item.hasChanged = false;
            const oldAggregatedItem = oldAggregatedMap.get(item.name);
            
            if (oldAggregatedItem) {
                const checkChange = (prop, label) => {
                    if ((item[prop] || 0) > (oldAggregatedItem[prop] || 0)) {
                        item.changes[prop] = true;
                        item.hasChanged = true;
                        logChange(`${item.name} ${label}`, oldAggregatedItem[prop], item[prop]);
                    }
                };
                checkChange('scoreEarned', '经验值');
                checkChange('timePlayed', '游戏时间');
                checkChange('usages', '使用量');
                checkChange('count', '数量');
            }
        });

        aggregatedNewData.sort((a, b) => (b.hasChanged - a.hasChanged) || (b.timePlayed || b.usages || 0) - (a.timePlayed || a.usages || 0));

        aggregatedNewData.forEach(item => {
            const cardDiv = document.createElement('div');
            cardDiv.className = `data-card ${item.hasChanged ? 'changed' : ''}`;
            let imageUrl = item.imageUrl ? item.imageUrl.replace(/s\.(eu\.tankionline|3dtank)\.com/g, 'res.3dtank.com').replace(/\.tnk/g, '.webp') : null;

            const createField = (label, value, prop) => {
                const isChanged = item.changes[prop];
                const diff = oldAggregatedMap.has(item.name) ? (item[prop] || 0) - (oldAggregatedMap.get(item.name)[prop] || 0) : 0;
                const changeHTML = isChanged ? createChangeSpan(diff) : '';
                return `<div class="${isChanged ? 'field-changed' : ''}"><strong>${label}:</strong> ${value}${changeHTML}</div>`;
            };

            let cardHTML = `<div class="item-name">${item.name || '-'}</div>`;
            if (imageUrl) cardHTML += `<img src="${imageUrl}" class="item-image" alt="${item.name}" loading="lazy" />`;
            if (item.properties != null) cardHTML += createField('特性', item.properties?.toLocaleString(), 'properties');
            if (item.grade != null && item.grade != -1) cardHTML += `<div><strong>当前等级:</strong> ${getGradeName(item.grade)}</div>`;
            if (item.scoreEarned != null && title !== '使用的道具' && title !== '收到的礼物') cardHTML += createField('获得经验值', item.scoreEarned?.toLocaleString(), 'scoreEarned');
            if (item.timePlayed > 0 && title !== '使用的道具' && title !== '收到的礼物') cardHTML += createField('游戏时间', formatTime(item.timePlayed), 'timePlayed');
            if (item.count != null) cardHTML += createField('数量', item.count?.toLocaleString(), 'count');
            if (item.usages != null) cardHTML += createField('使用量', item.usages?.toLocaleString(), 'usages');
            
            // Translate the entire card's content before rendering
            cardDiv.innerHTML = translateText(cardHTML);

            if (item.detailedGrades && item.detailedGrades.length > 1) {
                const button = document.createElement('button');
                button.className = 'view-data-button';
                button.textContent = (title === '玩过的模式' || title=== '使用的迷彩') ? '查看各类型数据' : '查看各等级数据';
                button.addEventListener('click', () => showDetailedGrades(item.name, item.detailedGrades, title));
                cardDiv.appendChild(button);
            }
            container.appendChild(cardDiv);
        });
    }

    // --- Utility & Helper Functions ---
    function clearDisplay(fullReset = false) {
        elements.resultsWrapper.style.display = 'none';
        elements.profileSummary.innerHTML = '';
        elements.rankingsTableContainer.innerHTML = '';
        elements.listsContainer.innerHTML = '';
        elements.errorMessage.textContent = '';
        if (fullReset) {
            lastProfileData = null;
            changeLog = [];
            renderChangeLog();
        }
    }
    
    function setLoading(isLoading) {
        elements.loader.style.display = isLoading ? 'flex' : 'none';
        elements.fetchButton.disabled = isLoading;
        if (isLoading) {
            elements.initialMessage.style.display = 'none';
            elements.errorMessage.textContent = '';
        }
    }

    function displayError(message) {
        elements.errorMessage.textContent = message;
    }

    function aggregateItems(items, title) {
        const aggregated = {};
        const keySelector = (item) => title === '使用的防御模块' ? `${item.name}-${item.resistance}` : item.name;

        items.forEach(item => {
            const key = keySelector(item);
            if (!aggregated[key]) {
                aggregated[key] = { ...item, timePlayed: 0, scoreEarned: 0, detailedGrades: [] };
            }
            aggregated[key].timePlayed += item.timePlayed || 0;
            aggregated[key].scoreEarned += item.scoreEarned || 0;
            if (item.grade > (aggregated[key].grade || -1)) {
                aggregated[key].grade = item.grade;
            }
            aggregated[key].detailedGrades.push({ ...item });
        });
        return Object.values(aggregated);
    }
    
    function showDetailedGrades(name, detailedGrades, title) {
        const isMode = title === '玩过的模式';
        const sortedGrades = [...detailedGrades].sort((a, b) => isMode ? (a.type || '').localeCompare(b.type || '') : (a.grade ?? -1) - (b.grade ?? -1));
        
        const tableRows = sortedGrades.map(data => {
            const typeOrGrade = isMode ? (data.type || '-') : getGradeName(data.grade);
            return `<tr>
                        <td>${translateText(typeOrGrade)}</td>
                        <td>${formatTime(data.timePlayed)}</td>
                        <td>${data.scoreEarned?.toLocaleString() || '-'}</td>
                    </tr>`;
        }).join('');

        const modalHTML = `
            <div class="modal-overlay">
                <div class="modal-content">
                    <h3>${translateText(name)} - ${isMode ? '各类型数据' : '各等级数据'}</h3>
                    <table style="width:100%;">
                        <thead>
                            <tr>
                                <th>${isMode ? '类型' : '等级'}</th>
                                <th>游戏时间</th>
                                <th>获得经验值</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    <button class="close-button">关闭</button>
                </div>
            </div>`;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const overlay = document.body.lastElementChild;
        overlay.addEventListener('click', (e) => { if (e.target === overlay || e.target.classList.contains('close-button')) { overlay.remove(); } });
    }

    function formatTime(ms) {
        if (!ms || ms <= 0) return '无记录';
        const h = Math.floor(ms / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = (ms % 60000) / 1000; // 精确显示到毫秒级（不改动）
        const parts = [];
        if (h > 0) parts.push(`${h} 小时`);
        if (m > 0) parts.push(`${m} 分钟`);
        if (s > 0 || parts.length === 0) parts.push(`${s} 秒`);
        return parts.join(' ');
    }
    
    function getGradeName(grade) { return grade != null ? `Mk${grade + 1}` : '-'; }
</script>
</body>
</html>
