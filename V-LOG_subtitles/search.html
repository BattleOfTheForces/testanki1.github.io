<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-LOG 字幕搜索工具 (修正版)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 15px;
            background-color: #f8f9fa;
        }
        h1 {
            color: #0056b3;
            text-align: center;
        }
        #search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #search-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        #search-button {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        #search-button:hover {
            background-color: #0056b3;
        }
        #status {
            text-align: center;
            font-style: italic;
            color: #666;
            margin: 20px 0;
        }
        .result-item {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .result-item h3 {
            margin-top: 0;
            font-size: 1.1em;
        }
        .result-item a {
            color: #0056b3;
            text-decoration: none;
        }
        .result-item a:hover {
            text-decoration: underline;
        }
        .result-item p {
            margin: 5px 0 0;
            color: #555;
            white-space: pre-wrap; /* 保留换行和空格 */
            word-break: break-word;
        }
        .highlight {
            background-color: #fff3cd;
            color: #856404;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 3px;
        }
        footer {
            text-align: center;
            margin-top: 40px;
            font-size: 0.9em;
            color: #999;
        }
    </style>
</head>
<body>

    <h1>V-LOG 字幕内容搜索</h1>
    <p>在 <a href="https://testanki1.github.io/V-LOG_subtitles/" target="_blank">testanki1.github.io/V-LOG_subtitles</a> 上的所有 <code>.srt</code> 文件中进行关键词搜索。</p>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="输入要查找的关键词...">
        <button id="search-button">搜索</button>
    </div>

    <div id="status"></div>
    <div id="results"></div>
    
    <footer>
        <p>此工具通过 GitHub API 获取文件列表，然后直接请求文件内容进行搜索。</p>
    </footer>

<script>
    const owner = 'testanki1';
    // *** 修正点 1: 仓库名称是 testanki1.github.io ***
    const repo = 'testanki1.github.io';
    const subtitlesPath = 'V-LOG_subtitles';
    
    // *** 修正点 2: API URL 需要包含文件夹路径 ***
    const apiURL = `https://api.github.com/repos/${owner}/${repo}/contents/${subtitlesPath}`;
    
    // GitHub Pages 的文件基础 URL (这个保持不变，因为最终的访问地址是对的)
    const fileBaseURL = `https://testanki1.github.io/${subtitlesPath}/`;

    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const statusDiv = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    
    let srtFiles = [];

    // 页面加载时预先获取文件列表
    async function fetchFileList() {
        statusDiv.textContent = '正在获取字幕文件列表...';
        try {
            const response = await fetch(apiURL);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`GitHub API 请求失败: ${response.status} - ${errorData.message}`);
            }
            const data = await response.json();
            srtFiles = data
                .filter(file => file.type === 'file' && file.name.endsWith('.srt'))
                .map(file => file.name);

            if (srtFiles.length > 0) {
                 statusDiv.textContent = `已成功加载 ${srtFiles.length} 个字幕文件，请输入关键词进行搜索。`;
            } else {
                 statusDiv.textContent = '警告：在该仓库的指定文件夹中未找到 .srt 文件。';
            }
        } catch (error) {
            console.error('获取文件列表失败:', error);
            statusDiv.textContent = `错误：无法加载文件列表。请检查网络连接或浏览器控制台获取更多信息。 ${error.message}`;
        }
    }
    
    // 执行搜索的核心函数
    async function performSearch() {
        const searchTerm = searchInput.value.trim();
        if (!searchTerm) {
            alert('请输入搜索关键词！');
            return;
        }
        if (srtFiles.length === 0) {
            alert('没有可供搜索的字幕文件，请等待文件列表加载完成。');
            return;
        }

        // 清理旧结果并显示状态
        resultsDiv.innerHTML = '';
        statusDiv.textContent = `正在 ${srtFiles.length} 个文件中搜索 "${searchTerm}"...`;
        
        const searchPromises = srtFiles.map(fileName => searchInFile(fileName, searchTerm));
        
        try {
            const allMatches = await Promise.all(searchPromises);
            const flattenedMatches = allMatches.flat(); // 将多维数组展平成一维

            if (flattenedMatches.length === 0) {
                statusDiv.textContent = `在所有文件中均未找到 "${searchTerm}"。`;
            } else {
                statusDiv.textContent = `搜索完成！共找到 ${flattenedMatches.length} 条匹配结果。`;
                flattenedMatches.forEach(displayResult);
            }
        } catch (error) {
             console.error('搜索过程中发生错误:', error);
             statusDiv.textContent = `搜索失败: ${error.message}`;
        }
    }
    
    // 在单个文件中搜索
    async function searchInFile(fileName, searchTerm) {
        // fileURL 拼接逻辑是正确的
        const fileURL = fileBaseURL + encodeURIComponent(fileName);
        const matches = [];
        try {
            const response = await fetch(fileURL);
            if (!response.ok) {
                console.warn(`无法下载文件: ${fileName}`);
                return []; // 如果某个文件下载失败，跳过它
            }
            const content = await response.text();
            const lines = content.split('\n');
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            for (const line of lines) {
                // 忽略 SRT 的时间戳行和序号行（通常以数字开头）
                if (!/^\d/.test(line) && line.toLowerCase().includes(lowerCaseSearchTerm)) {
                    matches.push({ fileName, line });
                }
            }
        } catch (error) {
             console.error(`处理文件 ${fileName} 时出错:`, error);
        }
        return matches;
    }

    // 在页面上显示一条结果
    function displayResult(result) {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';

        const regex = new RegExp(escapeRegExp(searchInput.value), 'gi');
        const highlightedLine = result.line.replace(regex, `<span class="highlight">$&</span>`);

        resultItem.innerHTML = `
            <h3>
                <a href="${fileBaseURL}${encodeURIComponent(result.fileName)}" target="_blank">${result.fileName}</a>
            </h3>
            <p>${highlightedLine}</p>
        `;
        resultsDiv.appendChild(resultItem);
    }

    // 转义正则表达式中的特殊字符
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // 添加事件监听
    searchButton.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            performSearch();
        }
    });
    
    // 页面加载完成后，自动获取文件列表
    document.addEventListener('DOMContentLoaded', fetchFileList);

</script>
</body>
</html>
