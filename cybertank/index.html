<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Synth Tank Showcase - Free Camera</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        canvas { display: block; }
        #fullscreen-prompt { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; background-color: rgba(0, 0, 0, 0.5); padding: 8px 15px; border-radius: 20px; font-family: sans-serif; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.5s; }

        /* --- 新增部分: 音乐控制按钮样式 --- */
        #audio-control {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        #audio-control svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        /* 默认显示“静音”图标（表示当前已静音，点击可播放） */
        .icon-unmuted { display: none; }

        /* 当按钮有 'playing' class 时，显示“正在播放”图标 */
        #audio-control.playing .icon-unmuted { display: block; }
        #audio-control.playing .icon-muted { display: none; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.149.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="fullscreen-prompt">Tap to enter fullscreen</div>

    <!-- --- 新增部分: 音乐控制按钮和Audio元素 --- -->
    <div id="audio-control">
        <!-- 静音状态图标 (喇叭上有斜杠) -->
        <svg class="icon-muted" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zM21.17 3.83l-1.41-1.41L3.83 18.17l1.41 1.41L21.17 3.83z"/></svg>
        <!-- 播放状态图标 (普通喇叭) -->
        <svg class="icon-unmuted" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
    </div>
    <audio id="background-music" src="assets/bounce tanki loop cut (no intro).opus" loop preload="auto"></audio>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { EXRLoader } from 'three/addons/loaders/EXRLoader.js';

        let scene, camera, renderer;
        const loader = new GLTFLoader();

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.outputEncoding = THREE.sRGBEncoding;
            document.body.appendChild(renderer.domElement);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 15);

            setupFreeCameraControls();

            const exrLoader = new EXRLoader();
            exrLoader.load('assets/Minigame_Synth_Environment_4096x2048.exr', (texture) => {
                texture.mapping = THREE.EquirectangularReflectionMapping;
                scene.background = texture;
                scene.environment = texture;
            });

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffeeb1, 1);
            directionalLight.position.set(-20, 30, 20);
            scene.add(directionalLight);

            loadModels();
            setupFullscreen();
            // --- 新增部分: 调用音乐控制器设置函数 ---
            setupAudioControls();
            window.addEventListener('resize', onWindowResize);
        }

        function loadModels() {
            loader.load('assets/Minigame_Synth_Scene.glb', (gltf) => {
                scene.add(gltf.scene);
            });
            loader.load('assets/Minigame_Synth_Tank.glb', (gltf) => {
                const tankModel = gltf.scene;
                tankModel.position.set(0, 0.2, 0);
                tankModel.rotation.y = Math.PI;
                scene.add(tankModel);
            });
        }
        
        // --- 新增部分: 音乐控制逻辑 ---
        function setupAudioControls() {
            const audioControl = document.getElementById('audio-control');
            const audio = document.getElementById('background-music');

            audioControl.addEventListener('click', () => {
                if (audio.paused) {
                    audio.play().catch(e => console.error("Audio play failed:", e));
                    audioControl.classList.add('playing');
                } else {
                    audio.pause();
                    audioControl.classList.remove('playing');
                }
            });
        }

        function setupFreeCameraControls() { /* ... 此部分代码不变 ... */ }
        function setupFullscreen() { /* ... 此部分代码不变 ... */ }
        function onWindowResize() { /* ... 此部分代码不变 ... */ }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
